# Биостатистика. ДЗ №5
# Клюев Максим

```{r}
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(survminer)
library(MASS)
```

```{r}
# Загрузка датасета
df <- read.csv("wisconsin_breast_cancer.csv")

head(df)
str(df)
```

В колонке `diagnosis` содержится информация об опухоли (M = злокачественная, B = доброкачественная).

## ЗАДАНИЕ 1

# Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
# Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

Попробуем применить линейную регрессию:

```{r}
fit1 <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = df) 
summary(fit1)
```
```{r}
# График для 'area_mean'
plot(df$area_mean, df$radius_mean, main="Radius vs Area",
     xlab="Area Mean", ylab="Radius Mean")
abline(lm(radius_mean ~ area_mean, data=df), col="red")

# График для 'perimeter_mean' 
plot(df$perimeter_mean, df$radius_mean, main="Radius vs Perimeter",
     xlab="Perimeter Mean", ylab="Radius Mean")
abline(lm(radius_mean ~ perimeter_mean, data=df), col="blue")

# График для 'symmetry_mean'
plot(df$symmetry_mean, df$radius_mean, main="Radius vs Symmetry",
     xlab="Symmetry Mean", ylab="Radius Mean")
abline(lm(radius_mean ~ symmetry_mean, data=df), col="green")

```
Мы видим, что  есть прямая зависимость радиуса от средней площади и среднего периметра и обратная зависимость от средней симметричности.
Значение p показывает очень высокую статистическую значимость этих результатов.

Распределение остатков показывает, что медиана остатков близка к нулю, что указывает на хорошую подгонку модели.
R-квадрат 0.9971: Это говорит о том, что модель объясняет 99.71% вариации radius_mean. Это очень высокое значение, также указывающее на отличную подгонку модели.
Экстремально высокая F-статистика и очень маленькое общее p-значение указывают на общую статистическую значимость модели.

Однако стоит отметить, что такие высокие значения R-квадрат могут также указывать на возможную переобученность модели.
Давайте проверим соблюдение требований к применению линейной регрессии:

```{r}
# 1. Проверка линейности и гомоскедастичности
plot(fit1, which = 1) # Построение графика остатков против фиттед 

# 2. Проверка нормальности распределения остатков
plot(fit1, which = 2) # Q-Q plot для остатков

# 3. Тест Шапиро-Уилка
shapiro.test(residuals(fit1))

# 4. Проверка гомоскедастичности
ncvTest(fit1)

# 5. Проверка на мультиколлинеарность
vif(fit1) # VIF для каждого предиктора

```

График остатков показывает:
- линия, представляющая сглаженные остатки, показывает некоторую нелинейную тенденцию в остатках;
- видны некоторые точки с большими отклонениями от остальных, что может указывать на наличие выбросов в данных;
- не видно явной воронки или изменения дисперсии остатков, что указывает на гетероскедастичность.

На графике Q-Q мы видим, что в целом точки лежат вдоль прямой линии, что свидетельствует о нормальности распределения данных, однако на концах, особенно в левой части графика отклонения от прямой сильно выражены, что может указывать на наличие тяжёлых хвостов в распределении остатков.

Результаты теста Шапиро-Уилка на нормальность остатков показывают значение статистики W = 0.95781 и очень маленькое p-значение (p = 1.072e-11), что значительно меньше стандартного порога в 0.05. Это указывает на то, что можно отклонить нулевую гипотезу о нормальности распределения остатков.

Тест на гетероскедастичность указывает на значительную гетероскедастичность в остатках модели.

Значения VIF для area_mean и perimeter_mean очень высоки, что указывает на наличие сильной мультиколлинеарности. Это не удивительно, так как площадь и периметр сильно коррелированы. 

Попробуем решить данные проблемы с нормальностью распределения данных и гетероскедастичностью путем применения робастной регрессии и отдельным анализом связи радиуса с каждой из переменных (для избежания мультиколлинеарности):

```{r}
# Модели робастной регрессии для каждой переменной
fit_area <- rlm(radius_mean ~ area_mean, data = df)
summary(fit_area)

fit_perimeter <- rlm(radius_mean ~ perimeter_mean, data = df)
summary(fit_perimeter)

fit_symmetry <- rlm(radius_mean ~ symmetry_mean, data = df)
summary(fit_symmetry)


```

Модель с area_mean:
area_mean 0.0103: Изменение среднего радиуса на каждую единицу изменения средней площади.
Остаточная стандартная ошибка: 0.3665, что указывает на среднее отклонение остатков модели от фактических значений.
Коэффициенты значимы: Значения t-статистики для обоих коэффициентов очень высоки, что указывает на их статистическую значимость.

Модель с perimeter_mean:
perimeter_mean 0.1456: Изменение среднего радиуса на каждую единицу изменения среднего периметра.
Остаточная стандартная ошибка: 0.182, что меньше, чем в модели с area_mean, показывая, что предсказания модели ближе к фактическим значениям.
Коэффициенты также значимы: Значения t-статистики очень высоки, указывая на статистическую значимость коэффициентов.

Модель с symmetry_mean:
symmetry_mean 18.5722: Коэффициент для symmetry_mean говорит нам, что при увеличении средней симметричности на одну единицу, средний радиус опухоли увеличивается в среднем на 18.5722 единицы. Этот коэффициент также статистически значим, с t-значением 3.5517.

Результаты показывают, что все три модели является статистически значимым предиктором для среднего радиуса (radius_mean), наиболее точные результаты обсеспечиает area_mean, наименее - symmetry_mean.

Для окончательного вывода о качестве моделей нам потребуется дальнейший анализ, включая оценку влияния выбросов и потенциальной нелинейности в данных.



## ЗАДАНИЕ 2

#Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

#Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

Применим модель логистической ререссии, так как зависимая переменная категориальная:

```{r}
df$diagnosis <- ifelse(df$diagnosis == "M", 1, 0)
gfit1 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = df, family = "binomial")
summary(gfit1)
```
radius_mean: предиктор статистически не значим (p = 0.687).
area_mean: также статистически не значим (p = 0.137).
texture_mean: Коэффициент для средней текстуры составляет 0.20917, показывая значимую положительную связь с вероятностью диагноза "M" (p < 0.001).

Только texture_mean оказался статистически значимым предиктором (p < 0.001), что указывает на сильную взаимосвязь между средней текстурой и диагнозом. Это означает, что изменения в средней текстуре имеют значительное влияние на вероятность диагноза "M".

Преобразуем лог-шансы в шансы:

```{r}
exp(coefficients(gfit1))
```
Таким образом, статистически значимый предиктор texture_mean указывает на то, что с каждым увеличением texture_mean на одну единицу шансы на исход "M" увеличиваются примерно на 23%.

Построим графики:

```{r}
# Вычисляем средние значения 
mean_radius <- mean(df$radius_mean, na.rm = TRUE)
mean_area <- mean(df$area_mean, na.rm = TRUE)
mean_texture <- mean(df$texture_mean, na.rm = TRUE)

# Создаем датасеты для варьирования каждого предиктора
data_radius <- data.frame(radius_mean = seq(min(df$radius_mean, na.rm = TRUE), max(df$radius_mean, na.rm = TRUE), length.out = 100),
                          area_mean = mean_area,
                          texture_mean = mean_texture)

data_area <- data.frame(radius_mean = mean_radius,
                        area_mean = seq(min(df$area_mean, na.rm = TRUE), max(df$area_mean, na.rm = TRUE), length.out = 100),
                        texture_mean = mean_texture)

data_texture <- data.frame(radius_mean = mean_radius,
                           area_mean = mean_area,
                           texture_mean = seq(min(df$texture_mean, na.rm = TRUE), max(df$texture_mean, na.rm = TRUE), length.out = 100))

# Вычисляем предсказанные вероятности 
data_radius$probability <- predict(gfit1, newdata=data_radius, type="response")
data_area$probability <- predict(gfit1, newdata=data_area, type="response")
data_texture$probability <- predict(gfit1, newdata=data_texture, type="response")

# Строим графики
p_radius <- ggplot(data_radius, aes(x=radius_mean, y=probability)) +
  geom_line() +
  labs(title="Вероятность злокачественной опухоли от среднего радиуса", x="Средний радиус", y="Вероятность")

p_area <- ggplot(data_area, aes(x=area_mean, y=probability)) +
  geom_line() +
  labs(title="Вероятность злокачественной опухоли от средней площади", x="Средняя площадь", y="Вероятность")

p_texture <- ggplot(data_texture, aes(x=texture_mean, y=probability)) +
  geom_line() +
  labs(title="Вероятность злокачественной опухоли от средней текстуры", x="Средняя текстура", y="Вероятность")

print(p_radius)
print(p_area)
print(p_texture)

```

Построим регрессионную модель на 3-х факторах:

```{r}
gfit2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = df,
      family = "binomial")

summary(gfit2)
```
Все коэффициенты показывают высокие p-значения, что говорит о их статистической незначимости в контексте данной модели. 



## ЗАДАНИЕ 3.

# Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

-   inst: код учреждения;
-   time: время выживаемости в днях;
-   status: 1 = цензурирование, 2 = смерть;
-   age: возраст в годах;
-   sex: мужской = 1, женский = 2;
-   ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
-   meal.cal: калории потребляемой пищи;
-   wt.loss: потеря веса за последние полгода.


# Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

```{r}
# Загружаем данные
lung = survival::lung

# Создаем и визуализируем модель выживаемости 
lung_survfit <- survfit(Surv(time, status == 2) ~ sex, data = lung) 
ggsurvplot(lung_survfit, data = lung, risk.table = TRUE, pval = TRUE, conf.int = TRUE,
           palette = c("#E7B800", "#2E9FDF"), 
           xlab = "Время (дни)", ylab = "Функция выживаемости", title = "Выживаемость в зависимости от пола")

# Выполняем log-rank тест 
lung_survdiff <- survdiff(Surv(time, status == 2) ~ sex, data = lung)
print(lung_survdiff) 
```
График выживаемости и log-rank тест показывают статистически значимую (p= 0.001) большую выживаемость женщин по сравнению с мужчинами.


# Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.

```{r}
# Построение графика кумулятивной функции рисков для каждого пола
ggsurvplot(
  lung_survfit, 
  data = lung, 
  fun = "cumhaz", в
  risk.table = TRUE, 
  pval = TRUE, 
  conf.int = TRUE, 
  palette = c("#E7B800", "#2E9FDF"), 
  xlab = "Время (дни)", 
  ylab = "Кумулятивная функция риска", 
  title = "Кумулятивная функция риска в зависимости от пола"
)

```
График показывает, что риск смертности у мужчин выше, чем у женщин. Со временем риск возрастает у обоих полов.


# С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

```{r}
# Построение модели Кокса 
lung_cox <- coxph(Surv(time, status == 2) ~ sex, data = lung)
summary(lung_cox)

```
Экспонента коэффициента (exp(coef)): Для женщин равна 0.5880. Это означает, что женщины имеют примерно на 41.2% меньший риск смерти от рака легких по сравнению с мужчинами.
Статистическая значимость: P-значение для переменной равно 0.00149, что является статистически значимым.
Таким образом, на основе результатов модели Кокса можно сделать вывод, что пол пациента оказывает статистически значимое влияние на выживаемость при раке легких, и женщины имеют меньший риск смерти от этого заболевания по сравнению с мужчинами.